<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Guitar-Triggered Table Topics (Song Edition)</title>
<style>
  :root {
    --bg: #0e1116;
    --card: #161b22;
    --accent: #2ea043;
    --accent2: #58a6ff;
    --text: #e6edf3;
    --muted: #8b949e;
    --warn: #f0883e;
  }
  body { margin: 0; background: var(--bg); color: var(--text);
    font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }

  /* Layout */
  #appWrap { min-height: 100dvh; display: grid; grid-template-rows: auto 1fr auto; }
  header {
    padding: 14px 18px; border-bottom: 1px solid #21262d;
    display: flex; align-items: center; gap: 12px; flex-wrap: wrap;
    background: rgba(14,17,22,0.9);
  }
  .status-badge {
    padding: 6px 10px; border-radius: 8px; background: var(--card);
    border: 1px solid #30363d; font-weight: 600;
  }
  .conf { color: var(--muted); margin-left: 4px; font-weight: 500; }
  .controls { margin-left: auto; display: flex; gap: 8px; flex-wrap: wrap; }
  button, select {
    background: var(--card); color: var(--text); border: 1px solid #30363d;
    padding: 8px 12px; border-radius: 8px; cursor: pointer; font-weight: 600;
  }
  button:hover { border-color: var(--accent2); }
  main {
    display: grid; gap: 16px; padding: 16px;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    align-items: start;
  }
  .col {
    background: var(--card); border: 1px solid #30363d; border-radius: 12px;
    padding: 12px; min-height: 260px;
  }
  .col h2 { margin: 0 0 12px 0; font-size: 18px; display: flex; align-items: center; gap: 8px; }
  .pill { font-size: 12px; color: var(--muted); padding: 2px 8px; border-radius: 999px; border: 1px solid #30363d; }
  .card {
    background: #0b1220; border: 1px solid #30363d; border-radius: 10px;
    padding: 12px; margin: 10px 0; position: relative; min-height: 68px;
  }
  .card .cover {
    position: absolute; inset: 0; background: linear-gradient(135deg, #1f2937, #0b1220);
    display: grid; place-items: center; border-radius: 10px; color: #c9d1d9;
    letter-spacing: 0.6px; border: 1px dashed #3b4451;
  }
  .card.revealed .cover { display: none; }
  .card .q { color: #e6edf3; font-size: 15px; line-height: 1.4; }
  .chip {
    font-size: 11px; color: var(--muted); border: 1px solid #30363d; padding: 2px 6px;
    border-radius: 6px; display: inline-block; margin-top: 6px;
  }
  footer { padding: 10px 16px; border-top: 1px solid #21262d; color: var(--muted);
    display: flex; gap: 16px; align-items: center; flex-wrap: wrap; background: rgba(14,17,22,0.9); }
  .meter { width: 180px; height: 6px; background: #202938; border-radius: 6px; overflow: hidden; }
  .meter > div { height: 100%; background: var(--accent); width: 0%; transition: width 80ms linear; }
  .hint { color: var(--muted); font-size: 13px; }
  .warn { color: var(--warn); }

  /* Blur when modal is open */
  .blurred { filter: blur(6px); transition: filter 140ms ease; pointer-events: none; user-select: none; }

  /* Modal overlay */
  .modal {
    position: fixed; inset: 0; z-index: 1000;
    display: none; justify-content: center; align-items: center;
    background: rgba(0,0,0,0.55);
    padding: 20px;
  }
  .modal.show { display: flex; }
  .modal-card {
    width: min(92vw, 980px);
    background: #0b1220;
    border: 1px solid #30363d; border-radius: 16px;
    box-shadow: 0 12px 40px rgba(0,0,0,0.6);
    padding: 22px 24px;
  }
  .modal-head {
    display: flex; align-items: center; justify-content: space-between; gap: 10px;
    margin-bottom: 12px;
  }
  .modal-title {
    font-weight: 700; letter-spacing: .3px; color: #c9d1d9; font-size: 14px;
  }
  .modal-body {
    color: #e6edf3;
    font-weight: 700;
    line-height: 1.25;
    font-size: clamp(22px, 3.6vw, 40px);
    white-space: pre-wrap;
  }
  .modal-actions {
    margin-top: 16px; display: flex; gap: 10px; flex-wrap: wrap; justify-content: flex-end;
  }
  .btn-primary { background: var(--accent2); color: #051426; border-color: #2b6db7; }
  .btn-ghost   { background: transparent; color: #c9d1d9; }
</style>
</head>
<body>
<div id="appWrap">
  <header>
    <div class="status-badge" id="status">Mic: <span id="micState">off</span></div>
    <div class="status-badge">Detected: <span id="detChord">‚Äî</span><span class="conf" id="detConf"></span></div>
    <div class="status-badge">Root: <span id="detRoot">‚Äî</span></div>
    <div class="controls">
      <button id="startBtn">üé§ Start</button>
      <button id="stopBtn" disabled>‚èπ Stop</button>
      <button id="resetBtn">‚ôª Reset All</button>
      <select id="sensitivity">
        <option value="low">Sensitivity: Low</option>
        <option value="med" selected>Sensitivity: Medium</option>
        <option value="high">Sensitivity: High</option>
      </select>
    </div>
  </header>

  <main id="board"></main>

  <footer>
    <div class="meter"><div id="levelBar"></div></div>
    <div class="hint">Strum a clean chord. Mapped chords: <b>E, Am, A, G, Dm, D, F, C, Em</b>. ‚Äî The question pops up big, background blurs; press <b>Esc</b>/<b>Space</b> when done.</div>
  </footer>
</div>

<!-- Modal -->
<div id="modal" class="modal" aria-hidden="true" role="dialog" aria-label="Selected Table Topic">
  <div class="modal-card" role="document">
    <div class="modal-head">
      <div class="modal-title" id="modalTitle">Table Topic</div>
      <button class="btn-ghost" id="closeX" aria-label="Close">‚úï</button>
    </div>
    <div class="modal-body" id="modalQuestion">Question goes here‚Ä¶</div>
    <div class="modal-actions">
      <span class="hint" style="margin-right:auto">Press <b>Esc</b> / <b>Space</b> / <b>Enter</b> to close</span>
      <button class="btn-primary" id="doneBtn">Done</button>
    </div>
  </div>
</div>

<script>
// -------------------- CONFIG --------------------
const COLUMNS = ['E', 'Am', 'A', 'G', 'Dm', 'D', 'F', 'C', 'Em'];

const questionBank = {
  'E': [
    "What‚Äôs an energizing song that boosts your mood‚Äîand why?",
    "Which song lyric describes your life right now?",
    "What‚Äôs the most unforgettable guitar riff you‚Äôve heard?",
    "If your morning routine were a song, what would it sound like?",
    "Tell us about a song that helped you overcome something tough.",
    "What‚Äôs a song you can never resist singing along to?",
    "Which artist‚Äôs style matches your personality?",
    "What‚Äôs the first song you remember loving as a child?",
    "If you had to teach a lesson through a song, which one would you pick?",
    "Share a ‚Äòsoundtrack moment‚Äô from your life."
  ],
  'Am': [
    "What song makes you emotional every single time?",
    "If your heartbreak had a theme song, what would it be?",
    "What‚Äôs the most beautiful sad song you know?",
    "Which song lyric taught you something deep?",
    "What music do you listen to when you need healing?",
    "Which love song feels the most honest to you?",
    "Share a song that reminds you of someone special.",
    "Which song feels like a hug?",
    "What melody describes your quiet moments?",
    "What song would play during your ‚Äòmain character‚Äô scene?"
  ],
  'A': [
    "What‚Äôs your personal anthem‚Äîand why?",
    "What song makes you feel unstoppable?",
    "Which chorus do you belt at full volume?",
    "If success had a soundtrack, which track would be on it?",
    "What workout or power song pumps you up?",
    "What live performance changed how you see music?",
    "Which upbeat song immediately lifts your mood?",
    "If you walked onto a stage like a superstar, what song would play?",
    "What‚Äôs your favorite karaoke showstopper?",
    "Which song always inspires you to take action?"
  ],
  'G': [
    "Which happy song never fails to make you smile?",
    "What‚Äôs the most fun song you‚Äôve danced to?",
    "What‚Äôs your go‚Äëto song for celebrations?",
    "Share a song that reminds you of friendship.",
    "What song sums up your happiest memory?",
    "If joy were a song, how would it sound?",
    "Which song instantly puts you in a good mood?",
    "What nostalgic song takes you back in time?",
    "What song makes you think of sunshine?",
    "If your week had a theme song, what would it be?"
  ],
  'Dm': [
    "What dramatic song feels like it was written for you?",
    "What song makes you feel like you‚Äôre in a movie?",
    "Which song builds tension in a way you love?",
    "What‚Äôs the most powerful emotional climax in a song you know?",
    "If your life had a dramatic background score, what would it be?",
    "What song best expresses frustration or struggle?",
    "Which cinematic soundtrack gives you goosebumps?",
    "What song captures the suspenseful moments in your life?",
    "What‚Äôs your favorite intense music moment?",
    "Which song makes ordinary things feel epic?"
  ],
  'D': [
    "What song guided you through a major decision?",
    "Which song feels like a long road trip?",
    "What‚Äôs your journey anthem?",
    "What song lyric changed your perspective?",
    "What‚Äôs the best ‚Äòmoving on‚Äô song?",
    "If your life were a playlist, what‚Äôs track #1?",
    "What song reminds you to stay focused?",
    "What song helped you take a brave step?",
    "Which song reminds you of home?",
    "What‚Äôs the soundtrack of your current chapter?"
  ],
  'F': [
    "What song did your family love‚Äîand why?",
    "What song shaped your music taste growing up?",
    "What timeless song will you always love?",
    "Which old song feels like a life philosophy?",
    "What classic should everyone listen to at least once?",
    "What song connects you to your culture or heritage?",
    "What song reminds you of stability or safety?",
    "Which melody feels like ‚Äòhome‚Äô?",
    "What song do you want to pass on to the next generation?",
    "What song do you never get tired of hearing?"
  ],
  'C': [
    "What‚Äôs the most creative music video you‚Äôve seen?",
    "Which song makes your imagination run wild?",
    "What lyric inspires you to dream?",
    "What unusual song or genre surprised you?",
    "What song sparks creativity instantly?",
    "Which artist takes creative risks you admire?",
    "What‚Äôs the weirdest but coolest song you know?",
    "What song helps you think differently?",
    "Which melody feels like inspiration to you?",
    "What song pushes you to create something new?"
  ],
  'Em': [
    "What song captures your current mood perfectly?",
    "What music helps you reflect on life?",
    "What song helps you get through tough days?",
    "Which slow song makes you think deeply?",
    "What song feels like late‚Äënight thoughts?",
    "What‚Äôs the most meaningful lyric you‚Äôve heard?",
    "What song brings out your introspective side?",
    "What‚Äôs the best song to listen to alone?",
    "Which melody soothes your soul?",
    "What song would play during a personal transformation scene?"
  ],
};

const UI_CARDS_PER_COL = 10;         // show 10 cards per column
const TRIGGER_COOLDOWN_MS = 1400;    // minimal time between triggers
const CONSISTENCY_WINDOWS = 3;       // frames that must agree
const STRUM_HOLD_MS = 180;           // stability window (ms)
let MIN_CONFIDENCE = 0.42;           // adjusted by sensitivity

// -------------------- BOARD RENDER --------------------
const boardEl = document.getElementById('board');
const appWrap = document.getElementById('appWrap');
const columns = {};
function renderBoard() {
  boardEl.innerHTML = '';
  COLUMNS.forEach(name => {
    const col = document.createElement('div');
    col.className = 'col';
    col.dataset.key = name;
    col.innerHTML = `
      <h2>${name} <span class="pill">Songs & Table Topics</span></h2>
      <div class="cards"></div>
      <button class="manualBtn">Reveal next</button>
    `;
    const cardsEl = col.querySelector('.cards');
    const qList = (questionBank[name] || []);
    for (let i = 0; i < UI_CARDS_PER_COL; i++) {
      const q = qList[i] || "Add more questions in code ‚Üí questionBank";
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <div class="cover">üéµ</div>
        <div class="q">${q}</div>
        <span class="chip">#${i+1}</span>
      `;
      // Allow reopening revealed questions
      card.addEventListener('click', () => {
        if (card.classList.contains('revealed')) openModal(q, name, i+1);
      });
      cardsEl.appendChild(card);
    }
    col.querySelector('.manualBtn').onclick = () => revealNext(name);
    boardEl.appendChild(col);
    columns[name] = { el: col, nextIndex: 0 };
  });
}
renderBoard();

function revealNext(name) {
  const col = columns[name];
  if (!col) return;
  const cards = col.el.querySelectorAll('.card');
  if (col.nextIndex >= cards.length) { flash(col.el, 'All cards revealed.'); return; }
  const idx = col.nextIndex;
  const card = cards[idx];
  card.classList.add('revealed');
  const qText = card.querySelector('.q').textContent || '';
  openModal(qText, name, idx + 1);
  col.nextIndex++;
}

function resetAll() {
  Object.values(columns).forEach(c => {
    c.nextIndex = 0;
    c.el.querySelectorAll('.card').forEach(card => card.classList.remove('revealed'));
  });
}

function flash(el, msg) {
  const b = document.createElement('div');
  b.textContent = msg;
  b.style.position = 'absolute';
  b.style.right = '12px';
  b.style.bottom = '12px';
  b.style.padding = '6px 10px';
  b.style.background = '#1f6feb';
  b.style.color = 'white';
  b.style.borderRadius = '8px';
  b.style.fontSize = '12px';
  el.style.position = 'relative';
  el.appendChild(b);
  setTimeout(() => b.remove(), 900);
}

// -------------------- MODAL LOGIC --------------------
const modalEl = document.getElementById('modal');
const modalTitleEl = document.getElementById('modalTitle');
const modalQEl = document.getElementById('modalQuestion');
const doneBtn = document.getElementById('doneBtn');
const closeX = document.getElementById('closeX');

let modalOpen = false;

function openModal(qText, chordName, number) {
  if (modalOpen) return;
  modalOpen = true;
  modalTitleEl.textContent = `Chord: ${chordName} ‚Ä¢ Card #${number}`;
  modalQEl.textContent = qText;
  modalEl.classList.add('show');
  modalEl.setAttribute('aria-hidden', 'false');
  appWrap.classList.add('blurred');
  doneBtn.focus({ preventScroll: true });
}

function closeModal() {
  modalOpen = false;
  modalEl.classList.remove('show');
  modalEl.setAttribute('aria-hidden', 'true');
  appWrap.classList.remove('blurred');
}

doneBtn.addEventListener('click', closeModal);
closeX.addEventListener('click', closeModal);
// Click outside the card closes as well
modalEl.addEventListener('click', (e) => {
  if (e.target === modalEl) closeModal();
});
document.addEventListener('keydown', (e) => {
  if (!modalOpen) return;
  if (e.key === 'Escape' || e.key === ' ' || e.key === 'Enter') {
    e.preventDefault();
    closeModal();
  }
});

// -------------------- AUDIO + CHORD DETECTION --------------------
const detChordEl = document.getElementById('detChord');
const detConfEl = document.getElementById('detConf');
const detRootEl = document.getElementById('detRoot');
const levelBar = document.getElementById('levelBar');

const A4 = 440;
function freqToMidi(f) { return Math.round(12 * Math.log2(f / A4) + 69); }
function midiToPc(m) { return (m % 12 + 12) % 12; }
const PC_NAMES = ['C','C#','D','Eb','E','F','F#','G','Ab','A','Bb','B'];

function detectChordFromSpectrum(freqData, sampleRate, fftSize) {
  // 1) Loudness estimate
  let sum = 0;
  for (let i = 0; i < freqData.length; i++) sum += freqData[i];
  const avg = sum / freqData.length;
  const loudness = avg / 255; // 0..1

  // 2) Peak picking
  const peaks = [];
  const binHz = sampleRate / fftSize;
  for (let i = 3; i < freqData.length - 3; i++) {
    const v = freqData[i];
    if (v > freqData[i-1] && v > freqData[i+1] && v > 40) {
      const freq = i * binHz;
      if (freq > 70 && freq < 1500) peaks.push({ i, v, f: freq });
    }
  }
  peaks.sort((a,b) => b.v - a.v);
  const top = peaks.slice(0, 7);

  // 3) Pitch classes
  const pcs = new Array(12).fill(0);
  top.forEach(p => {
    const midi = freqToMidi(p.f);
    const pc = midiToPc(midi);
    pcs[pc] += p.v;
  });

  // 4) Triad template matching (major/minor)
  const templates = [];
  for (let r = 0; r < 12; r++) {
    const major = [r, (r+4)%12, (r+7)%12];
    const minor = [r, (r+3)%12, (r+7)%12];
    const scoreMaj = major.reduce((s, p) => s + pcs[p], 0);
    const scoreMin = minor.reduce((s, p) => s + pcs[p], 0);
    const total = pcs.reduce((a,b)=>a+b,0) || 1;
    templates.push(
      { name: PC_NAMES[r],     score: scoreMaj/total, root: PC_NAMES[r], type: 'major' },
      { name: PC_NAMES[r]+'m', score: scoreMin/total, root: PC_NAMES[r], type: 'minor' }
    );
  }
  templates.sort((a,b) => b.score - a.score);
  const best = templates[0];
  return { chord: best.name, confidence: best.score, root: best.root, loudness };
}

let audioCtx, analyser, source, dataArray, rafId;
let lastTriggerAt = 0;
let stableQueue = [];
let currentSensitivity = 'med';
let micStream; // keep to stop safely

// -------------------- TOAST (error/status popups) --------------------
function toast(msg, kind='info') {
  const t = document.createElement('div');
  t.textContent = msg;
  t.style.position = 'fixed';
  t.style.left = '50%';
  t.style.top = '16px';
  t.style.transform = 'translateX(-50%)';
  t.style.background = kind==='error' ? '#b42318' : '#1f6feb';
  t.style.color = '#fff';
  t.style.padding = '8px 12px';
  t.style.borderRadius = '8px';
  t.style.zIndex = '2000';
  t.style.boxShadow = '0 8px 24px rgba(0,0,0,.3)';
  document.body.appendChild(t);
  setTimeout(()=>t.remove(), 3200);
}

// -------------------- MIC START/STOP (patched) --------------------
const micStateEl = document.getElementById('micState');
const startBtn = document.getElementById('startBtn');
const stopBtn  = document.getElementById('stopBtn');
const resetBtn = document.getElementById('resetBtn');
const sensSel  = document.getElementById('sensitivity');

async function startAudio() {
  try {
    // IMPORTANT: works only on https or http://localhost (not file://)
    micStream = await navigator.mediaDevices.getUserMedia({
      audio: { echoCancellation: false, noiseSuppression: false }
    });
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 4096;
    analyser.smoothingTimeConstant = 0.8;
    source = audioCtx.createMediaStreamSource(micStream);
    source.connect(analyser);
    dataArray = new Uint8Array(analyser.frequencyBinCount);
    micStateEl.textContent = 'on';
    toast('Microphone started ‚úÖ');
    loop();
  } catch (err) {
    console.error('Mic error:', err);
    micStateEl.textContent = 'off';
    startBtn.disabled = false;   // let user retry
    stopBtn.disabled = true;

    if (location.protocol === 'file:') {
      toast('Open via http://localhost (not file://). Run: python -m http.server 8000', 'error');
    } else if (err && (err.name === 'NotAllowedError' || err.name === 'SecurityError')) {
      toast('Mic permission blocked. Click the lock icon ‚Üí Site settings ‚Üí Microphone ‚Üí Allow.', 'error');
    } else if (err && err.name === 'NotFoundError') {
      toast('No microphone found / selected. Check OS input device.', 'error');
    } else {
      toast('Could not start microphone. See console (F12) for details.', 'error');
    }
  }
}

function stopAudio() {
  try {
    if (micStream) micStream.getTracks().forEach(t => t.stop());
    if (audioCtx && audioCtx.state !== 'closed') audioCtx.close();
  } catch {}
  cancelAnimationFrame(rafId);
  micStateEl.textContent = 'off';
  toast('Microphone stopped ‚èπÔ∏è');
}

// Button wiring with safe state handling
startBtn.onclick = async () => {
  startBtn.disabled = true;
  stopBtn.disabled = true;
  await startAudio();
  if (micStateEl.textContent === 'on') {
    stopBtn.disabled = false;
  } else {
    // start failed; re-enable Start
    startBtn.disabled = false;
  }
};
stopBtn.onclick  = () => {
  stopAudio();
  startBtn.disabled = false;
  stopBtn.disabled = true;
};
resetBtn.onclick = resetAll;
sensSel.onchange = (e) => {
  const v = e.target.value;
  currentSensitivity = v;
  MIN_CONFIDENCE = v === 'high' ? 0.36 : v === 'med' ? 0.42 : 0.48;
};

// Warn if opened as file://
window.addEventListener('load', () => {
  if (location.protocol === 'file:') {
    toast('Open via http://localhost:8000 (not file://). Mic needs a secure context.', 'error');
  }
});

// -------------------- MAIN LOOP --------------------
function loop() {
  analyser.getByteFrequencyData(dataArray);
  const { chord, confidence, root, loudness } = detectChordFromSpectrum(
    dataArray, audioCtx.sampleRate, analyser.fftSize
  );
  levelBar.style.width = (loudness * 100).toFixed(1) + '%';
  detChordEl.textContent = chord;
  detConfEl.textContent = ` (conf ${confidence.toFixed(2)})`;
  detRootEl.textContent = root;

  const now = performance.now();
  const loudEnough = loudness > (currentSensitivity === 'high' ? 0.05 : currentSensitivity === 'med' ? 0.08 : 0.12);
  const confident = confidence >= MIN_CONFIDENCE;

  if (!modalOpen && loudEnough && confident) {
    stableQueue.push({ chord, t: now });
    while (stableQueue.length && now - stableQueue[0].t > STRUM_HOLD_MS) stableQueue.shift();
    const agree = stableQueue.filter(x => x.chord === chord).length;
    if (agree >= CONSISTENCY_WINDOWS) {
      maybeTrigger(chord, now);
      stableQueue.length = 0;
    }
  } else {
    // decay
    stableQueue.length = Math.max(0, stableQueue.length - 1);
  }

  rafId = requestAnimationFrame(loop);
}

function maybeTrigger(chord, now) {
  if (modalOpen) return; // pause triggers while modal open
  if (now - lastTriggerAt < TRIGGER_COOLDOWN_MS) return;
  lastTriggerAt = now;

  if (columns[chord]) {
    revealNext(chord);
  } else {
    const root = chord.replace('m','');
    if (columns[root+'m']) revealNext(root+'m');
    else if (columns[root]) revealNext(root);
  }
}
</script>
</body>
</html>