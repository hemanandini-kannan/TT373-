<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Guitar-Triggered Table Topics (Song Edition)</title>
<style>
  :root {
    --bg: #0e1116;
    --card: #161b22;
    --accent: #2ea043;
    --accent2: #58a6ff;
    --text: #e6edf3;
    --muted: #8b949e;
    --warn: #f0883e;
  }
  body { margin: 0; background: var(--bg); color: var(--text);
    font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }

  /* Layout */
  #appWrap { min-height: 100dvh; display: grid; grid-template-rows: auto 1fr auto; }
  header {
    padding: 14px 18px; border-bottom: 1px solid #21262d;
    display: flex; align-items: center; gap: 12px; flex-wrap: wrap;
    background: rgba(14,17,22,0.9);
  }
  .status-badge {
    padding: 6px 10px; border-radius: 8px; background: var(--card);
    border: 1px solid #30363d; font-weight: 600;
  }
  .conf { color: var(--muted); margin-left: 4px; font-weight: 500; }
  .controls { margin-left: auto; display: flex; gap: 8px; flex-wrap: wrap; }
  button, select {
    background: var(--card); color: var(--text); border: 1px solid #30363d;
    padding: 8px 12px; border-radius: 8px; cursor: pointer; font-weight: 600;
  }
  button:hover { border-color: var(--accent2); }
  main {
    display: grid; gap: 16px; padding: 16px;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    align-items: start;
  }
  .col {
    background: var(--card); border: 1px solid #30363d; border-radius: 12px;
    padding: 12px; min-height: 260px;
  }
  .col h2 { margin: 0 0 12px 0; font-size: 18px; display: flex; align-items: center; gap: 8px; }
  .pill { font-size: 12px; color: var(--muted); padding: 2px 8px; border-radius: 999px; border: 1px solid #30363d; }
  .card {
    background: #0b1220; border: 1px solid #30363d; border-radius: 10px;
    padding: 12px; margin: 10px 0; position: relative; min-height: 68px;
  }
  .card .cover {
    position: absolute; inset: 0; background: linear-gradient(135deg, #1f2937, #0b1220);
    display: grid; place-items: center; border-radius: 10px; color: #c9d1d9;
    letter-spacing: 0.6px; border: 1px dashed #3b4451;
  }
  .card.revealed .cover { display: none; }
  .card .q { color: #e6edf3; font-size: 15px; line-height: 1.4; }
  .chip {
    font-size: 11px; color: var(--muted); border: 1px solid #30363d; padding: 2px 6px;
    border-radius: 6px; display: inline-block; margin-top: 6px;
  }
  footer { padding: 10px 16px; border-top: 1px solid #21262d; color: #muted;
    display: flex; gap: 16px; align-items: center; flex-wrap: wrap; background: rgba(14,17,22,0.9); }
  .meter { width: 180px; height: 6px; background: #202938; border-radius: 6px; overflow: hidden; }
  .meter > div { height: 100%; background: var(--accent); width: 0%; transition: width 80ms linear; }
  .hint { color: var(--muted); font-size: 13px; }
  .warn { color: var(--warn); }

  /* Blur when modal is open */
  .blurred { filter: blur(6px); transition: filter 140ms ease; pointer-events: none; user-select: none; }

  /* Modal overlay */
  .modal {
    position: fixed; inset: 0; z-index: 1000;
    display: none; justify-content: center; align-items: center;
    background: rgba(0,0,0,0.55);
    padding: 20px;
  }
  .modal.show { display: flex; }
  .modal-card {
    width: min(92vw, 980px);
    background: #0b1220;
    border: 1px solid #30363d; border-radius: 16px;
    box-shadow: 0 12px 40px rgba(0,0,0,0.6);
    padding: 22px 24px;
  }
  .modal-head {
    display: flex; align-items: center; justify-content: space-between; gap: 10px;
    margin-bottom: 12px;
  }
  .modal-title {
    font-weight: 700; letter-spacing: .3px; color: #c9d1d9; font-size: 14px;
  }
  .modal-body {
    color: #e6edf3;
    font-weight: 700;
    line-height: 1.25;
    font-size: clamp(22px, 3.6vw, 40px);
    white-space: pre-wrap;
  }
  .modal-actions {
    margin-top: 16px; display: flex; gap: 10px; flex-wrap: wrap; justify-content: flex-end;
  }
  .btn-primary { background: var(--accent2); color: #051426; border-color: #2b6db7; }
  .btn-ghost   { background: transparent; color: #c9d1d9; }
</style>
</head>

<body>
<div id="appWrap">
  <header>
    <div class="status-badge">Mic: <span id="micState">off</span></div>
    <div class="status-badge">Detected: <span id="detChord">‚Äî</span><span class="conf" id="detConf"></span></div>
    <div class="status-badge">Root: <span id="detRoot">‚Äî</span></div>
    <div class="controls">
      <button id="startBtn">üé§ Start</button>
      <button id="stopBtn" disabled>‚èπ Stop</button>
      <button id="resetBtn">‚ôª Reset All</button>
      <select id="sensitivity">
        <option value="low">Sensitivity: Low</option>
        <option value="med">Sensitivity: Medium</option>
        <option value="high" selected>Sensitivity: High</option>
        <option value="ultra">Sensitivity: Ultra</option> <!-- ‚òÖ added -->
      </select>
      <button id="testBtn">‚ö° Test Trigger</button>
    </div>
  </header>

  <main id="board"></main>

  <footer>
    <div class="meter"><div id="levelBar"></div></div>
    <div class="hint">Strum a clean chord. Cards pop when detected.</div>
  </footer>
</div>

<!-- Modal -->
<div id="modal" class="modal">
  <div class="modal-card">
    <div class="modal-head">
      <div class="modal-title" id="modalTitle"></div>
      <button class="btn-ghost" id="closeX">‚úï</button>
    </div>
    <div class="modal-body" id="modalQuestion"></div>
    <div class="modal-actions">
      <span class="hint" style="margin-right:auto">Esc / Space / Enter to close</span>
      <button class="btn-primary" id="doneBtn">Done</button>
    </div>
  </div>
</div>

<script>
/* ------------------  CONFIG  ------------------ */

const COLUMNS = ['E','Am','A','G','Dm','D','F','C','Em'];

const UI_CARDS_PER_COL = 10;
const TRIGGER_COOLDOWN_MS = 900;
const CONSISTENCY_WINDOWS = 2;
const STRUM_HOLD_MS = 260;
let   MIN_CONFIDENCE = 0.34;

/* ------------------  QUESTION BANK  ------------------ */
const questionBank = {
  'E': [
    "What‚Äôs an energizing song that boosts your mood‚Äîand why?",
    "Which song lyric describes your life right now?",
    "What‚Äôs the most unforgettable guitar riff you‚Äôve heard?",
    "If your morning routine were a song, what would it sound like?",
    "Tell us about a song that helped you overcome something tough.",
    "What‚Äôs a song you can never resist singing along to?",
    "Which artist‚Äôs style matches your personality?",
    "What‚Äôs the first song you remember loving as a child?",
    "If you had to teach a lesson through a song, which one would you pick?",
    "Share a ‚Äòsoundtrack moment‚Äô from your life."
  ],
  'Am': [
    "What song makes you emotional every single time?",
    "If your heartbreak had a theme song, what would it be?",
    "What‚Äôs the most beautiful sad song you know?",
    "Which song lyric taught you something deep?",
    "What music do you listen to when you need healing?",
    "Which love song feels the most honest to you?",
    "Share a song that reminds you of someone special.",
    "Which song feels like a hug?",
    "What melody describes your quiet moments?",
    "What song would play during your ‚Äòmain character‚Äô scene?"
  ],
  'A': [
    "What‚Äôs your personal anthem‚Äîand why?",
    "What song makes you feel unstoppable?",
    "Which chorus do you belt at full volume?",
    "If success had a soundtrack, which track would be on it?",
    "What workout or power song pumps you up?",
    "What live performance changed how you see music?",
    "Which upbeat song immediately lifts your mood?",
    "If you walked onto a stage like a superstar, what song would play?",
    "What‚Äôs your favorite karaoke showstopper?",
    "Which song always inspires you to take action?"
  ],
  'G': [
    "Which happy song never fails to make you smile?",
    "What‚Äôs the most fun song you‚Äôve danced to?",
    "What‚Äôs your go‚Äëto song for celebrations?",
    "Share a song that reminds you of friendship.",
    "What song sums up your happiest memory?",
    "If joy were a song, how would it sound?",
    "Which song instantly puts you in a good mood?",
    "What nostalgic song takes you back in time?",
    "What song makes you think of sunshine?",
    "If your week had a theme song, what would it be?"
  ],
  'Dm': [
    "What dramatic song feels like it was written for you?",
    "What song makes you feel like you‚Äôre in a movie?",
    "Which song builds tension in a way you love?",
    "What‚Äôs the most powerful emotional climax in a song you know?",
    "If your life had a dramatic background score, what would it be?",
    "What song best expresses frustration or struggle?",
    "Which cinematic soundtrack gives you goosebumps?",
    "What song captures the suspenseful moments in your life?",
    "What‚Äôs your favorite intense music moment?",
    "Which song makes ordinary things feel epic?"
  ],
  'D': [
    "What song guided you through a major decision?",
    "Which song feels like a long road trip?",
    "What‚Äôs your journey anthem?",
    "What song lyric changed your perspective?",
    "What‚Äôs the best ‚Äòmoving on‚Äô song?",
    "If your life were a playlist, what‚Äôs track #1?",
    "What song reminds you to stay focused?",
    "What song helped you take a brave step?",
    "Which song reminds you of home?",
    "What‚Äôs the soundtrack of your current chapter?"
  ],
  'F': [
    "What song did your family love‚Äîand why?",
    "What song shaped your music taste growing up?",
    "What timeless song will you always love?",
    "Which old song feels like a life philosophy?",
    "What classic should everyone listen to at least once?",
    "What song connects you to your culture or heritage?",
    "What song reminds you of stability or safety?",
    "Which melody feels like ‚Äòhome‚Äô?",
    "What song do you want to pass on to the next generation?",
    "What song do you never get tired of hearing?"
  ],
  'C': [
    "What‚Äôs the most creative music video you‚Äôve seen?",
    "Which song makes your imagination run wild?",
    "What lyric inspires you to dream?",
    "What unusual song or genre surprised you?",
    "What song sparks creativity instantly?",
    "Which artist takes creative risks you admire?",
    "What‚Äôs the weirdest but coolest song you know?",
    "What song helps you think differently?",
    "Which melody feels like inspiration to you?",
    "What song pushes you to create something new?"
  ],
  'Em': [
    "What song captures your current mood perfectly?",
    "What music helps you reflect on life?",
    "What song helps you get through tough days?",
    "Which slow song makes you think deeply?",
    "What song feels like late‚Äënight thoughts?",
    "What‚Äôs the most meaningful lyric you‚Äôve heard?",
    "What song brings out your introspective side?",
    "What‚Äôs the best song to listen to alone?",
    "Which melody soothes your soul?",
    "What song would play during a personal transformation scene?"
  ]
};

/* ------------------ BOARD RENDER ------------------ */
const boardEl = document.getElementById("board");
const appWrap = document.getElementById("appWrap");
const columns = {};

function renderBoard() {
  boardEl.innerHTML = "";
  COLUMNS.forEach(name => {
    const col = document.createElement("div");
    col.className = "col";
    col.dataset.key = name;
    col.innerHTML = `
      <h2>${name} <span class="pill">Songs & Table Topics</span></h2>
      <div class="cards"></div>
      <button class="manualBtn">Reveal next</button>
    `;
    const cardsEl = col.querySelector(".cards");
    const list = questionBank[name];
    for (let i = 0; i < UI_CARDS_PER_COL; i++) {
      const q = list[i] || "Add more questions‚Ä¶";
      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <div class="cover">üéµ</div>
        <div class="q">${q}</div>
        <span class="chip">#${i+1}</span>
      `;
      card.addEventListener("click", () => {
        if (card.classList.contains("revealed"))
          openModal(q, name, i + 1);
      });
      cardsEl.appendChild(card);
    }
    col.querySelector(".manualBtn").onclick = () => revealNext(name);
    boardEl.appendChild(col);
    columns[name] = { el: col, nextIndex: 0 };
  });
}

renderBoard();

/* ------------------ REVEAL + MODAL ------------------ */

function revealNext(name) {
  const col = columns[name];
  const cards = col.el.querySelectorAll(".card");
  if (col.nextIndex >= cards.length) return;
  const card = cards[col.nextIndex];
  card.classList.add("revealed");
  const q = card.querySelector(".q").textContent;
  openModal(q, name, col.nextIndex + 1);
  col.nextIndex++;
}

const modal = document.getElementById("modal");
const modalTitle = document.getElementById("modalTitle");
const modalQuestion = document.getElementById("modalQuestion");
const closeX = document.getElementById("closeX");
const doneBtn = document.getElementById("doneBtn");

let modalOpen = false;

function openModal(q, chord, num) {
  if (modalOpen) return;
  modalOpen = true;
  modalTitle.textContent = `Chord: ${chord} ‚Ä¢ Card #${num}`;
  modalQuestion.textContent = q;
  modal.classList.add("show");
  appWrap.classList.add("blurred");
}

function closeModal() {
  modalOpen = false;
  modal.classList.remove("show");
  appWrap.classList.remove("blurred");
}

closeX.onclick = closeModal;
doneBtn.onclick = closeModal;

modal.onclick = e => { if (e.target === modal) closeModal(); };

document.addEventListener("keydown", e => {
  if (modalOpen && (e.key === "Escape" || e.key === " " || e.key === "Enter")) {
    e.preventDefault();
    closeModal();
  }
});

/* ------------------ KEYBOARD TRIGGERS ------------------ */

document.addEventListener("keydown", e => {
  if (modalOpen) return;
  const k = e.key.toUpperCase();
  if (k === "E") revealNext("E");
  if (k === "A") revealNext("A");
  if (k === "G") revealNext("G");
  if (k === "D") revealNext("D");
  if (k === "F") revealNext("F");
  if (k === "C") revealNext("C");
  if (k === "M") revealNext("Am");
  if (k === "N") revealNext("Dm");
  if (k === "R") revealNext("Em");
});

/* ------------------ AUDIO + DETECTION ------------------ */

const detChordEl = document.getElementById("detChord");
const detConfEl  = document.getElementById("detConf");
const detRootEl  = document.getElementById("detRoot");
const levelBar   = document.getElementById("levelBar");

let audioCtx, analyser, dataArray, micStream;
let rafId;
let lastTriggerAt = 0;
let stableQueue = [];
let currentSensitivity = "high";

/* ‚òÖ Ultra sensitivity + strum-latch additions */
const ULTRA_LOUD_GATE   = 0.018;  // lower loudness gate (more sensitive than High)
const ULTRA_CONFIDENCE  = 0.30;   // slightly lower chord confidence for Ultra
const LATCH_MS          = 360;    // accept short strum bursts (~0.36s)
const RISE_DELTA        = 0.012;  // loudness rise needed to arm latch
let armedUntil = 0;               // latch window end time
let prevLoud   = 0;               // previous loudness for rising-edge calc
/* ‚òÖ end additions */

const A4 = 440;
function freqToMidi(f) { return Math.round(12 * Math.log2(f / A4) + 69); }
function midiToPc(m)   { return (m % 12 + 12) % 12; }
const PC_NAMES = ['C','C#','D','Eb','E','F','F#','G','Ab','A','Bb','B'];

function detectChordFromSpectrum(freqData, sampleRate, fftSize) {
  let sum = 0;
  for (let i = 0; i < freqData.length; i++) sum += freqData[i];
  const loudness = sum / freqData.length / 255;

  const peaks = [];
  const binHz = sampleRate / fftSize;

  for (let i = 3; i < freqData.length - 3; i++) {
    const v = freqData[i];
    if (v > freqData[i-1] && v > freqData[i+1] && v > 28) {
      const f = i * binHz;
      if (f > 80 && f < 2000) peaks.push({ f, v });
    }
  }

  peaks.sort((a,b) => b.v - a.v);
  const top = peaks.slice(0,7);

  const pcs = new Array(12).fill(0);
  top.forEach(p => {
    const midi = freqToMidi(p.f);
    pcs[midiToPc(midi)] += p.v;
  });

  const templates = [];
  for (let r=0; r<12; r++) {
    const major = [r, (r+4)%12, (r+7)%12];
    const minor = [r, (r+3)%12, (r+7)%12];
    const sumMaj = major.reduce((s,p)=>s+pcs[p],0);
    const sumMin = minor.reduce((s,p)=>s+pcs[p],0);
    const total = pcs.reduce((a,b)=>a+b,0) || 1;
    templates.push(
      { name: PC_NAMES[r], score: sumMaj/total, root: PC_NAMES[r], type:'M' },
      { name: PC_NAMES[r]+'m', score: sumMin/total, root: PC_NAMES[r], type:'m' }
    );
  }

  templates.sort((a,b)=>b.score-a.score);
  const best = templates[0];
  return { chord: best.name, confidence: best.score, root: best.root, loudness };
}

/* ------------------ START/STOP MIC ------------------ */

const startBtn = document.getElementById("startBtn");
const stopBtn  = document.getElementById("stopBtn");
const resetBtn = document.getElementById("resetBtn");
const sensSel  = document.getElementById("sensitivity");
const testBtn  = document.getElementById("testBtn");
const micState = document.getElementById("micState");

testBtn.onclick = ()=> revealNext("E");

sensSel.onchange = e => {
  currentSensitivity = e.target.value;
  MIN_CONFIDENCE = currentSensitivity === "ultra" ? ULTRA_CONFIDENCE :
                   currentSensitivity === "high"  ? 0.34 :
                   currentSensitivity === "med"   ? 0.40 :
                                                     0.46;
};

async function startAudio() {
  try {
    micStream = await navigator.mediaDevices.getUserMedia({
      // ‚òÖ include autoGainControl to avoid flattening guitar attacks
      audio: { echoCancellation:false, noiseSuppression:false, autoGainControl:false }
    });

    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 4096;
    analyser.smoothingTimeConstant = 0.55;

    const src = audioCtx.createMediaStreamSource(micStream);

    const hp = audioCtx.createBiquadFilter();
    hp.type = "highpass";
    hp.frequency.value = 120;

    const lp = audioCtx.createBiquadFilter();
    lp.type = "lowpass";
    lp.frequency.value = 2500;

    src.connect(hp);
    hp.connect(lp);
    lp.connect(analyser);

    dataArray = new Uint8Array(analyser.frequencyBinCount);

    micState.textContent = "on";
    loop();

  } catch(e) {
    micState.textContent = "off";
  }
}

function stopAudio() {
  try { micStream.getTracks().forEach(t=>t.stop()); } catch{}
  try { audioCtx.close(); } catch{}

  cancelAnimationFrame(rafId);
  micState.textContent = "off";
}

startBtn.onclick = async ()=>{
  startBtn.disabled = true;
  stopBtn.disabled  = true;
  await startAudio();
  if (micState.textContent === "on") stopBtn.disabled = false;
  else startBtn.disabled = false;
};

stopBtn.onclick = ()=>{
  stopAudio();
  startBtn.disabled = false;
  stopBtn.disabled  = true;
};

resetBtn.onclick = ()=>{
  Object.values(columns).forEach(c=>{
    c.nextIndex = 0;
    c.el.querySelectorAll(".card").forEach(card=>card.classList.remove("revealed"));
  });
};

/* ------------------ LOOP ------------------ */

function loop() {
  analyser.getByteFrequencyData(dataArray);
  const { chord, confidence, root, loudness } =
    detectChordFromSpectrum(dataArray, audioCtx.sampleRate, analyser.fftSize);

  detChordEl.textContent = chord;
  detConfEl.textContent = ` (conf ${confidence.toFixed(2)}, loud ${loudness.toFixed(2)})`;
  detRootEl.textContent  = root;
  levelBar.style.width   = (loudness * 100).toFixed(1) + "%";

  // ‚òÖ gate per sensitivity (adds Ultra)
  const loudGate = currentSensitivity==="ultra" ? ULTRA_LOUD_GATE :
                   currentSensitivity==="high"  ? 0.030 :
                   currentSensitivity==="med"   ? 0.055 : 0.090;
  const loudEnough = loudness > loudGate;

  // ‚òÖ strum latch: catch short, non-continuous guitar attacks
  const rising = loudness > (prevLoud + RISE_DELTA);
  if (rising && loudness > ULTRA_LOUD_GATE) {
    armedUntil = performance.now() + LATCH_MS;   // open a short acceptance window
  }
  const armed = performance.now() <= armedUntil;

  const now = performance.now();

  if (!modalOpen && (loudEnough || armed) && confidence >= MIN_CONFIDENCE) {
    stableQueue.push({ chord, t:now });
    while (stableQueue.length &&
           now - stableQueue[0].t > STRUM_HOLD_MS)
      stableQueue.shift();

    const agree = stableQueue.filter(x=>x.chord===chord).length;
    if (agree >= CONSISTENCY_WINDOWS) {
      maybeTrigger(chord, now);
      stableQueue = [];
      armedUntil = 0; // close latch after a successful trigger
    }
  }

  prevLoud = loudness; // ‚òÖ keep for rising-edge detection
  rafId = requestAnimationFrame(loop);
}

/* ------------------ MAPPING ------------------ */

function maybeTrigger(chord, now) {
  if (modalOpen) return;
  if (now - lastTriggerAt < TRIGGER_COOLDOWN_MS) return;
  lastTriggerAt = now;

  if (columns[chord]) return revealNext(chord);

  const root = chord.replace("m","");
  if (columns[root+"m"]) return revealNext(root+"m");
  if (columns[root])     return revealNext(root);

  const targets = ['E','Am','A','G','Dm','D','F','C','Em'];
  const TO_PC = {C:0,'C#':1,D:2,Eb:3,E:4,F:5,'F#':6,G:7,Ab:8,A:9,Bb:10,B:11};

  const isMinor = chord.endsWith("m");
  const name = isMinor ? chord.slice(0,-1) : chord;
  const pc = TO_PC[name];
  if (pc == null) return;

  const best = targets
    .map(t=>{
      const tMinor = t.endsWith("m");
      const tName = tMinor ? t.slice(0,-1) : t;
      const tPc = TO_PC[tName];
      const dist = Math.min((pc-tPc+12)%12, (tPc-pc+12)%12);
      return {t,dist,typeMatch:(tMinor===isMinor)};
    })
    .sort((a,b)=>(a.dist-b.dist) || (b.typeMatch-a.typeMatch))[0];

  if (best) revealNext(best.t);
}

</script>
</body>
</html>

